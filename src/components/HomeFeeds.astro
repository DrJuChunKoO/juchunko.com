---
import { getIndexCards } from "../lib/indexCards";
import { ui } from "src/i18n/ui";
import { Sparkles, Newspaper, BookText, Signature, User, Rss, Mic, ArrowRight, ArrowUpRight } from "@lucide/astro";

type SupportedLang = "en" | "zh-TW";
const { lang = "zh-TW" } = Astro.props as { lang?: SupportedLang };

// Server-side: 聚合各外部資料來源
const { newsCards, blogCards, transpalCards, legislatorCards } = await getIndexCards(lang);

const titles = {
	legislator: ui[lang]["home.legislatorActivity.title"],
	news: ui[lang]["home.news.title"],
	blog: ui[lang]["home.blogRss.title"],
	transpal: ui[lang]["home.transpalRss.title"],
};

const subtitles = {
	legislator: ui[lang]["home.legislatorActivity.subtitle"],
	news: ui[lang]["home.news.subtitle"],
	blog: ui[lang]["home.blogRss.subtitle"],
	transpal: ui[lang]["home.transpalRss.subtitle"],
};

// Section configuration array (separates data from rendering)
const sections = [
	{
		key: "legislator",
		title: titles.legislator,
		subtitle: subtitles.legislator,
		href: `/${lang}/activities`,
		type: "display",
		cards: legislatorCards?.slice().reverse() ?? [],
		max: 3,
	},
	{
		key: "news",
		title: titles.news,
		subtitle: subtitles.news,
		href: `/${lang}/news`,
		type: "display",
		cards: newsCards?.slice().reverse() ?? [],
		max: 3,
	},
	{
		key: "blog",
		title: titles.blog,
		subtitle: subtitles.blog,
		href: `https://blog.juchunko.com/`,
		type: "album",
		cards: blogCards ?? [],
		max: 3,
	},
	{
		key: "transpal",
		title: titles.transpal,
		subtitle: subtitles.transpal,
		href: `https://transpal.juchunko.com/`,
		type: "album",
		cards: transpalCards?.slice().reverse() ?? [],
		max: 3,
	},
];
---

<!-- Use Tailwind utility classes instead of local CSS -->
<div class="homefeeds-grid mb-4 flex gap-4 overflow-x-auto max-md:-mx-4 max-md:px-4 max-md:pb-2 md:grid md:grid-cols-2">
	{
		sections.map((sec) => (
			<a
				class="section-card group relative flex shrink-0 flex-col overflow-hidden rounded-lg bg-gray-50 transition-colors hover:bg-gray-100 max-md:min-w-[70vw] dark:bg-white/5 dark:hover:bg-white/10"
				href={sec.href}
			>
				<div class="p-4 md:p-6">
					<div class="relative flex h-60 flex-col items-center gap-2">
						{sec.cards?.slice(0, sec.max).map((c, index) => {
							if (sec.type === "display") {
								const xOffset = (index - 1) * 20;
								const yOffset = (index - 1) * -50;
								return (
									<div
										class="from-muted/50 to-muted/25 absolute top-1/2 left-1/2 flex h-36 w-[min(26rem,75vw)] -translate-x-1/2 -translate-y-1/2 transform-gpu flex-col justify-between rounded-xl border bg-gradient-to-br px-6 py-4 drop-shadow-sm backdrop-blur-sm select-none dark:from-[#111]/50 dark:to-[#111]/25"
										style={`transform: translate(${xOffset}%, ${yOffset}%) skewY(6deg) rotate(0.5deg); z-index:${3 - index};`}
									>
										<div class="flex items-center gap-2">
											<span class="relative inline-flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-gray-50/50 text-gray-500 dark:bg-white/5 dark:text-white/80">
												{c.icon === "newspaper" ? (
													<Newspaper class="h-4 w-4" />
												) : c.icon === "propose" ? (
													<BookText class="h-4 w-4" />
												) : c.icon === "cosign" ? (
													<Signature class="h-4 w-4" />
												) : c.icon === "meet" ? (
													<User class="h-4 w-4" />
												) : (
													<Sparkles class="h-4 w-4" />
												)}
											</span>
											<p class="line-clamp-2 text-sm font-medium dark:text-white/80">{c.title}</p>
										</div>
										<p class="line-clamp-2 text-sm dark:text-white/50">{c.description}</p>
										<p class="text-muted-foreground text-xs">{c.date}</p>
									</div>
								);
							}
							// album
							const scale = 1 - index * 0.05;
							const yOffset = (index - 1) * -50;
							return (
								<div
									class="from-muted/50 to-muted/25 absolute top-1/2 left-1/2 flex h-36 w-[min(26rem,75vw)] -translate-x-1/2 -translate-y-1/2 transform-gpu flex-col justify-between rounded-xl border bg-gradient-to-b px-6 py-4 drop-shadow-sm backdrop-blur-sm select-none dark:from-[#111]/50 dark:to-[#111]/25"
									style={`transform: translateY(${yOffset}%) scale(${scale}); z-index:${3 - index};`}
								>
									<div class="flex items-center gap-2">
										<span class="relative inline-flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-gray-50/50 text-gray-500 dark:bg-white/5 dark:text-white/80">
											{c.icon === "newspaper" ? (
												<Newspaper class="h-4 w-4" />
											) : c.icon === "propose" ? (
												<BookText class="h-4 w-4" />
											) : c.icon === "cosign" ? (
												<Signature class="h-4 w-4" />
											) : c.icon === "meet" ? (
												<User class="h-4 w-4" />
											) : c.icon === "blog" ? (
												<Rss class="h-4 w-4" />
											) : c.icon === "transpal" ? (
												<Mic class="h-4 w-4" />
											) : (
												<Sparkles class="h-4 w-4" />
											)}
										</span>
										<p class="line-clamp-1 text-sm font-medium dark:text-white/80">{c.title}</p>
									</div>
									<p class="line-clamp-2 text-sm dark:text-white/50">{c.description}</p>
									<p class="text-muted-foreground text-xs">{c.date}</p>
								</div>
							);
						})}
					</div>
				</div>
				<div class="relative z-10 flex w-full items-center justify-between gap-2 bg-black/5 p-4 py-3 backdrop-blur-sm md:p-6 md:py-4 dark:bg-white/5">
					<header>
						<h2 class="font-semibold text-slate-900 md:text-xl dark:text-white">{sec.title}</h2>
						<p class="line-clamp-1 text-sm opacity-75 md:text-base">{sec.subtitle}</p>
					</header>
					{sec.href && sec.href.startsWith("http") ? (
						<ArrowUpRight class="h-6 w-6 text-gray-600 transition-transform group-hover:translate-x-1 group-hover:-translate-y-1 dark:text-gray-300" />
					) : (
						<ArrowRight class="h-6 w-6 text-gray-600 transition-transform group-hover:translate-x-1 dark:text-gray-300" />
					)}
				</div>
			</a>
		))
	}
</div>
