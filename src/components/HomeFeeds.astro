---
import { getIndexCards } from "../lib/indexCards";
import { ui } from "src/i18n/ui";
import { Sparkles, Newspaper, BookText, Signature, User, Rss, Mic, ArrowRight, ArrowUpRight } from "@lucide/astro";
import { cn } from "@/lib/utils";
import { removeMarkdown } from "@excalidraw/markdown-to-text";
type SupportedLang = "en" | "zh-TW";
const { lang = "zh-TW" } = Astro.props as { lang?: SupportedLang };

// Server-side: 聚合各外部資料來源
const { newsCards, blogCards, transpalCards, legislatorCards } = await getIndexCards(lang);

const titles = {
	legislator: ui[lang]["home.legislatorActivity.title"],
	news: ui[lang]["home.news.title"],
	blog: ui[lang]["home.blogRss.title"],
	transpal: ui[lang]["home.transpalRss.title"],
};

const subtitles = {
	legislator: ui[lang]["home.legislatorActivity.subtitle"],
	news: ui[lang]["home.news.subtitle"],
	blog: ui[lang]["home.blogRss.subtitle"],
	transpal: ui[lang]["home.transpalRss.subtitle"],
};

// Section configuration array (separates data from rendering)
const sections = [
	{
		key: "news",
		title: titles.news,
		subtitle: subtitles.news,
		href: `/${lang}/news`,
		type: "display",
		cards: newsCards ?? [],
		max: 3,
	},
	{
		key: "legislator",
		title: titles.legislator,
		subtitle: subtitles.legislator,
		href: `/${lang}/activities`,
		type: "display",
		cards: legislatorCards?.slice().reverse() ?? [],
		max: 3,
	},
	{
		key: "blog",
		title: titles.blog,
		subtitle: subtitles.blog,
		href: `https://blog.juchunko.com/`,
		type: "album",
		cards: blogCards.reverse() ?? [],
		max: 3,
	},
	{
		key: "transpal",
		title: titles.transpal,
		subtitle: subtitles.transpal,
		href: `https://transpal.juchunko.com/`,
		type: "album",
		cards: transpalCards ?? [],
		max: 3,
	},
];

// Utility: return the appropriate Icon component reference for an item (do NOT return JSX)
const getIcon = (name?: string) => {
	if (name === "newspaper") return Newspaper;
	if (name === "propose") return BookText;
	if (name === "cosign") return Signature;
	if (name === "meet") return User;
	if (name === "blog") return Rss;
	if (name === "transpal") return Mic;
	return Sparkles;
};

// NOTE: We avoid returning JSX from frontmatter helpers. Markup is rendered in template.

// Utility: calculate transform style for display layout
const calcDisplayTransform = (index: number) => {
	const xOffset = (index - 1) * 20;
	const yOffset = (index - 1) * -50;
	return `transform: translate(${xOffset}%, ${yOffset}%) skewY(5deg) rotate(0.5deg); z-index:${3 - index};`;
};

// Utility: calculate transform style for album layout (exponential decay semantics)
const calcAlbumTransform = (index: number) => {
	const baseOffset = 50; // percentage
	const offsetDecay = 0.6;
	const position = index - 1; // center is 0
	const yOffset = -position * (baseOffset * Math.pow(offsetDecay, Math.abs(position)));
	const baseScale = 1;
	const scaleDecay = 0.95;
	const scale = baseScale * Math.pow(scaleDecay, index);
	return `transform: translateY(${yOffset}%) scale(${scale}); z-index:${3 - index};`;
};
---

<!-- Use Tailwind utility classes instead of local CSS -->
<style>
	/* Home feed card entrance animation (staggered pop effect). Respects prefers-reduced-motion. */
	.home-card-appear {
		/* The outer container sets a transform (positioning). We animate an inner wrapper so
		   the positioning transform is preserved. This class controls the pop animation only. */
		opacity: 0;
		transform-origin: center center;
		will-change: transform, opacity;
		animation: home-card-pop 480ms cubic-bezier(0.2, 0.9, 0.2, 1) var(--delay, 0ms) both;
		/* Render layer to GPU for smoother animation */
		backface-visibility: hidden;
	}

	@keyframes home-card-pop {
		0% {
			opacity: 0;
			transform: translateY(18px) scale(0.8);
		}
		100% {
			opacity: 1;
			transform: translateY(0) scale(1);
		}
	}

	@media (prefers-reduced-motion: reduce) {
		.home-card-appear {
			animation: none !important;
			opacity: 1;
			transform: none !important;
		}
	}
</style>
<div class="homefeeds-grid mb-4 flex gap-4 overflow-x-auto max-lg:-mx-4 max-lg:px-4 max-lg:pb-2 lg:grid lg:grid-cols-2">
	{
		sections.map((sec, sIndex) => (
			<a
				class="section-card group bg-muted/50 hover:bg-muted relative flex shrink-0 flex-col overflow-hidden rounded-lg transition-colors max-lg:w-[50vw] max-md:w-[70vw]"
				href={sec.href}
			>
				<div class="p-4 md:p-6">
					<div class="relative flex h-60 flex-col data-[type=display]:max-md:scale-75" data-type={sec.type}>
						{sec.cards?.slice(0, sec.max).map((c, index) => {
							const delayMs = sIndex * 150 + index * 120;
							const transformStyle = sec.type === "display" ? calcDisplayTransform(index) : calcAlbumTransform(index);
							const styleStr = `--delay:${delayMs}ms; ${transformStyle}`;
							const Icon = getIcon(c.icon);
							return (
								<div
									class={cn(
										"border-muted-foreground/10 absolute top-1/2 left-1/2 w-[min(26rem,65vw)] -translate-x-1/2 -translate-y-1/2 transform-gpu rounded-xl border px-6 py-4 backdrop-blur-sm select-none",
										// gradientClass
										`data-[type=album]:bg-linear-to-b data-[type=display]:bg-linear-to-br`,
										"from-muted/50 to-muted/25",
									)}
									style={styleStr}
									data-type={sec.type}
								>
									{/* animated inner wrapper; we keep transform/positioning on the outer element */}
									<div class="home-card-appear">
										<div class="flex h-28 flex-col justify-between">
											<div class="flex items-center gap-2">
												<span class="relative inline-flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-gray-50/50 text-gray-500 drop-shadow-md dark:bg-white/5 dark:text-white/80">
													<Icon class="h-4 w-4" />
												</span>
												<p class={`line-clamp-2 text-sm font-medium dark:text-white/80`}>{c.title}</p>
											</div>
											<p class="line-clamp-2 text-sm dark:text-white/50">{removeMarkdown(c.description || "")}</p>
											<p class="text-muted-foreground text-xs">{c.date}</p>
										</div>
									</div>
								</div>
							);
						})}
					</div>
				</div>
				<div class="text-foreground relative z-10 flex w-full items-center justify-between gap-2 bg-black/5 p-4 py-3 backdrop-blur-sm md:p-6 md:py-4 dark:bg-white/5">
					<header>
						<h2 class="line-clamp-1 font-semibold md:text-xl">{sec.title}</h2>
						<p class="text-muted-foreground line-clamp-1 text-sm opacity-75 md:text-base">{sec.subtitle}</p>
					</header>
					{sec.href && sec.href.startsWith("http") ? (
						<ArrowUpRight class="h-6 w-6 transition-transform group-hover:translate-x-0.5 group-hover:-translate-y-0.5" />
					) : (
						<ArrowRight class="h-6 w-6 transition-transform group-hover:translate-x-0.5" />
					)}
				</div>
			</a>
		))
	}
</div>
