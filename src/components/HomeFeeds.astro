---
import { getIndexCards } from "../lib/indexCards";
import { ui } from "src/i18n/ui";
import { Sparkles, Newspaper, BookText, Signature, User, Rss, Mic, ArrowRight, ArrowUpRight } from "@lucide/astro";

type SupportedLang = "en" | "zh-TW";
const { lang = "zh-TW" } = Astro.props as { lang?: SupportedLang };

// Server-side: 聚合各外部資料來源
const { newsCards, blogCards, transpalCards, legislatorCards } = await getIndexCards(lang);

const titles = {
	legislator: ui[lang]["home.legislatorActivity.title"],
	news: ui[lang]["home.news.title"],
	blog: ui[lang]["home.blogRss.title"],
	transpal: ui[lang]["home.transpalRss.title"],
};

const subtitles = {
	legislator: ui[lang]["home.legislatorActivity.subtitle"],
	news: ui[lang]["home.news.subtitle"],
	blog: ui[lang]["home.blogRss.subtitle"],
	transpal: ui[lang]["home.transpalRss.subtitle"],
};

// Section configuration array (separates data from rendering)
const sections = [
	{
		key: "news",
		title: titles.news,
		subtitle: subtitles.news,
		href: `/${lang}/news`,
		type: "display",
		cards: newsCards ?? [],
		max: 3,
	},
	{
		key: "legislator",
		title: titles.legislator,
		subtitle: subtitles.legislator,
		href: `/${lang}/activities`,
		type: "display",
		cards: legislatorCards?.slice().reverse() ?? [],
		max: 3,
	},
	{
		key: "blog",
		title: titles.blog,
		subtitle: subtitles.blog,
		href: `https://blog.juchunko.com/`,
		type: "album",
		cards: blogCards.reverse() ?? [],
		max: 3,
	},
	{
		key: "transpal",
		title: titles.transpal,
		subtitle: subtitles.transpal,
		href: `https://transpal.juchunko.com/`,
		type: "album",
		cards: transpalCards ?? [],
		max: 3,
	},
];

// Utility: return the appropriate Icon component reference for an item (do NOT return JSX)
const getIcon = (name?: string) => {
	if (name === "newspaper") return Newspaper;
	if (name === "propose") return BookText;
	if (name === "cosign") return Signature;
	if (name === "meet") return User;
	if (name === "blog") return Rss;
	if (name === "transpal") return Mic;
	return Sparkles;
};

// Utility: CSS classes shared across both album and display cards (gradient left to right variance handled separately)
const baseCardClass =
	"from-muted/50 to-muted/25 absolute top-1/2 left-1/2 w-[min(26rem,65vw)] data-[type=display]:max-lg:-translate-x-[35%] -translate-x-1/2 -translate-y-1/2 transform-gpu rounded-xl border px-6 py-4 drop-shadow-sm backdrop-blur-sm select-none dark:from-[#111]/50 dark:to-[#111]/25";
const displayGradientClass = "bg-linear-to-br";
const albumGradientClass = "bg-linear-to-b";

// NOTE: We avoid returning JSX from frontmatter helpers. Markup is rendered in template.

// Utility: calculate transform style for display layout
const calcDisplayTransform = (index: number) => {
	const xOffset = (index - 1) * 20;
	const yOffset = (index - 1) * -50;
	return `transform: translate(${xOffset}%, ${yOffset}%) skewY(5deg) rotate(0.5deg); z-index:${3 - index};`;
};

// Utility: calculate transform style for album layout (exponential decay semantics)
const calcAlbumTransform = (index: number) => {
	const baseOffset = 50; // percentage
	const offsetDecay = 0.6;
	const position = index - 1; // center is 0
	const yOffset = -position * (baseOffset * Math.pow(offsetDecay, Math.abs(position)));
	const baseScale = 1;
	const scaleDecay = 0.95;
	const scale = baseScale * Math.pow(scaleDecay, index);
	return `transform: translateY(${yOffset}%) scale(${scale}); z-index:${3 - index};`;
};
---

<!-- Use Tailwind utility classes instead of local CSS -->
<style>
	/* Home feed card entrance animation (staggered). Respects prefers-reduced-motion. */
	.home-card-appear {
		opacity: 0;
		transform-origin: center center;
		will-change: opacity;
		animation: home-card-appear 380ms cubic-bezier(0.2, 0.9, 0.2, 1) var(--delay, 0ms) both;
	}

	@keyframes home-card-appear {
		to {
			opacity: 1;
		}
	}

	@media (prefers-reduced-motion: reduce) {
		.home-card-appear {
			animation: none !important;
			opacity: 1;
			transform: none !important;
		}
	}
</style>
<div class="homefeeds-grid mb-4 flex gap-4 overflow-x-auto max-lg:-mx-4 max-lg:px-4 max-lg:pb-2 lg:grid lg:grid-cols-2">
	{
		sections.map((sec, sIndex) => (
			<a
				class="section-card group relative flex shrink-0 flex-col overflow-hidden rounded-lg bg-gray-50 transition-colors hover:bg-gray-100 max-lg:w-[50vw] max-md:w-[70vw] dark:bg-white/5 dark:hover:bg-white/10"
				href={sec.href}
			>
				<div class="p-4 md:p-6">
					<div class="relative flex h-60 flex-col">
						{sec.cards?.slice(0, sec.max).map((c, index) => {
							const delayMs = sIndex * 150 + index * 120;
							const transformStyle = sec.type === "display" ? calcDisplayTransform(index) : calcAlbumTransform(index);
							const gradientClass = sec.type === "display" ? displayGradientClass : albumGradientClass;
							const styleStr = `--delay:${delayMs}ms; ${transformStyle}`;
							const titleClamp = sec.type === "display" ? 2 : 1;
							const Icon = getIcon(c.icon);
							const titleClampClass = titleClamp === 1 ? "line-clamp-1" : "line-clamp-2";
							return (
								<div class={`${baseCardClass} ${gradientClass}`} style={styleStr} data-type={sec.type}>
									<div class="home-card-appear flex h-28 flex-col justify-between">
										<div class="flex items-center gap-2">
											<span class="relative inline-flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-gray-50/50 text-gray-500 dark:bg-white/5 dark:text-white/80">
												<Icon class="h-4 w-4" />
											</span>
											<p class={`${titleClampClass} text-sm font-medium dark:text-white/80`}>{c.title}</p>
										</div>
										<p class="line-clamp-2 text-sm dark:text-white/50">{c.description}</p>
										<p class="text-muted-foreground text-xs">{c.date}</p>
									</div>
								</div>
							);
						})}
					</div>
				</div>
				<div class="relative z-10 flex w-full items-center justify-between gap-2 bg-black/5 p-4 py-3 backdrop-blur-sm md:p-6 md:py-4 dark:bg-white/5">
					<header>
						<h2 class="font-semibold text-slate-900 md:text-xl dark:text-white">{sec.title}</h2>
						<p class="line-clamp-1 text-sm opacity-75 md:text-base">{sec.subtitle}</p>
					</header>
					{sec.href && sec.href.startsWith("http") ? (
						<ArrowUpRight class="h-6 w-6 text-gray-600 transition-transform group-hover:translate-x-1 group-hover:-translate-y-1 dark:text-gray-300" />
					) : (
						<ArrowRight class="h-6 w-6 text-gray-600 transition-transform group-hover:translate-x-1 dark:text-gray-300" />
					)}
				</div>
			</a>
		))
	}
</div>
