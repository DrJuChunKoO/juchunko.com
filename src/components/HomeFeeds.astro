---
import { ui } from "src/i18n/ui";
import { Sparkles, Newspaper, BookText, Signature, User, Rss, Mic, ArrowRight, ArrowUpRight } from "@lucide/astro";
import { cn } from "@/lib/utils";
import { removeMarkdown } from "@excalidraw/markdown-to-text";
type SupportedLang = "en" | "zh-TW";
const { lang = "zh-TW" } = Astro.props as { lang?: SupportedLang };

const titles = {
	legislator: ui[lang]["home.legislatorActivity.title"],
	news: ui[lang]["home.news.title"],
	blog: ui[lang]["home.blogRss.title"],
	transpal: ui[lang]["home.transpalRss.title"],
};

const subtitles = {
	legislator: ui[lang]["home.legislatorActivity.subtitle"],
	news: ui[lang]["home.news.subtitle"],
	blog: ui[lang]["home.blogRss.subtitle"],
	transpal: ui[lang]["home.transpalRss.subtitle"],
};

// Section configuration array (separates data from rendering)
const sectionsConfig = [
	{
		key: "news",
		title: titles.news,
		subtitle: subtitles.news,
		href: `/${lang}/news`,
		type: "display",
		max: 3,
	},
	{
		key: "legislator",
		title: titles.legislator,
		subtitle: subtitles.legislator,
		href: `/${lang}/activities`,
		type: "display",
		max: 3,
	},
	{
		key: "blog",
		title: titles.blog,
		subtitle: subtitles.blog,
		href: `https://blog.juchunko.com/`,
		type: "album",
		max: 3,
	},
	{
		key: "transpal",
		title: titles.transpal,
		subtitle: subtitles.transpal,
		href: `https://transpal.juchunko.com/`,
		type: "album",
		max: 3,
	},
];

// Utility: return the appropriate Icon component reference for an item (do NOT return JSX)
const getIcon = (name?: string) => {
	if (name === "newspaper") return Newspaper;
	if (name === "propose") return BookText;
	if (name === "cosign") return Signature;
	if (name === "meet") return User;
	if (name === "blog") return Rss;
	if (name === "transpal") return Mic;
	return Sparkles;
};

// NOTE: We avoid returning JSX from frontmatter helpers. Markup is rendered in template.

// Utility: calculate transform style for display layout
const calcDisplayTransform = (index: number) => {
	const xOffset = (index - 1) * 20;
	const yOffset = (index - 1) * -50;
	return `transform: translate(${xOffset}%, ${yOffset}%) skewY(5deg) rotate(0.5deg); z-index:${3 - index};`;
};

// Utility: calculate transform style for album layout (exponential decay semantics)
const calcAlbumTransform = (index: number) => {
	const baseOffset = 50; // percentage
	const offsetDecay = 0.6;
	const position = index - 1; // center is 0
	const yOffset = -position * (baseOffset * Math.pow(offsetDecay, Math.abs(position)));
	const baseScale = 1;
	const scaleDecay = 0.95;
	const scale = baseScale * Math.pow(scaleDecay, index);
	return `transform: translateY(${yOffset}%) scale(${scale}); z-index:${3 - index};`;
};
---

<!-- Use Tailwind utility classes instead of local CSS -->
<style>
	/* Home feed card entrance animation (staggered pop effect). Respects prefers-reduced-motion. */
	.home-card-appear {
		/* The outer container sets a transform (positioning). We animate an inner wrapper so
		   the positioning transform is preserved. This class controls the pop animation only. */
		opacity: 0;
		transform-origin: center center;
		will-change: transform, opacity;
		animation: home-card-pop 480ms cubic-bezier(0.2, 0.9, 0.2, 1) var(--delay, 0ms) both;
		/* Render layer to GPU for smoother animation */
		backface-visibility: hidden;
	}

	@keyframes home-card-pop {
		0% {
			opacity: 0;
			transform: translateY(18px) scale(0.8);
		}
		100% {
			opacity: 1;
			transform: translateY(0) scale(1);
		}
	}

	@media (prefers-reduced-motion: reduce) {
		.home-card-appear {
			animation: none !important;
			opacity: 1;
			transform: none !important;
		}
	}

	.home-card-skeleton {
		background: linear-gradient(90deg, hsl(var(--muted)) 25%, hsl(var(--muted) / 0.5) 50%, hsl(var(--muted)) 75%);
		background-size: 200% 100%;
		animation: skeleton-loading 1.5s ease-in-out infinite;
	}

	@keyframes skeleton-loading {
		0% {
			background-position: 200% 0;
		}
		100% {
			background-position: -200% 0;
		}
	}
</style>

<div class="homefeeds-grid mb-4 flex gap-4 overflow-x-auto max-lg:-mx-4 max-lg:px-4 max-lg:pb-2 lg:grid lg:grid-cols-2" id="homefeeds-container" data-lang={lang}>
	<!-- Loading state skeleton cards -->
	{
		sectionsConfig.map((sec) => (
			<div class="section-card skeleton-card group bg-muted/50 relative flex shrink-0 flex-col overflow-hidden rounded-lg max-lg:w-[50vw] max-md:w-[70vw]">
				<div class="p-4 md:p-6">
					<div class="relative flex h-60 flex-col">
						<div class="home-card-skeleton absolute top-1/2 left-1/2 w-[min(26rem,65vw)] -translate-x-1/2 -translate-y-1/2 rounded-xl h-32"></div>
					</div>
				</div>
				<div class="text-foreground relative z-10 flex w-full items-center justify-between gap-2 bg-black/5 p-4 py-3 backdrop-blur-sm md:p-6 md:py-4 dark:bg-white/5">
					<header>
						<h2 class="line-clamp-1 font-semibold md:text-xl">{sec.title}</h2>
						<p class="text-muted-foreground line-clamp-1 text-sm opacity-75 md:text-base">{sec.subtitle}</p>
					</header>
					{sec.href && sec.href.startsWith("http") ? (
						<ArrowUpRight class="h-6 w-6" />
					) : (
						<ArrowRight class="h-6 w-6" />
					)}
				</div>
			</div>
		))
	}
</div>

<script is:inline define:vars={{ lang, sectionsConfig }}>
	// Transform style calculation functions
	function calcDisplayTransform(index) {
		const xOffset = (index - 1) * 20;
		const yOffset = (index - 1) * -50;
		return `transform: translate(${xOffset}%, ${yOffset}%) skewY(5deg) rotate(0.5deg); z-index:${3 - index};`;
	}

	function calcAlbumTransform(index) {
		const baseOffset = 50;
		const offsetDecay = 0.6;
		const position = index - 1;
		const yOffset = -position * (baseOffset * Math.pow(offsetDecay, Math.abs(position)));
		const baseScale = 1;
		const scaleDecay = 0.95;
		const scale = baseScale * Math.pow(scaleDecay, index);
		return `transform: translateY(${yOffset}%) scale(${scale}); z-index:${3 - index};`;
	}

	// Helper function to remove markdown (simplified version)
	function removeMarkdown(text) {
		if (!text) return '';
		return text
			.replace(/!\[.*?\]\(.*?\)/g, '')
			.replace(/\[([^\]]+)\]\(.*?\)/g, '$1')
			.replace(/#{1,6}\s+/g, '')
			.replace(/(\*\*|__)(.*?)\1/g, '$2')
			.replace(/(\*|_)(.*?)\1/g, '$2')
			.replace(/`{3}[\s\S]*?`{3}/g, '')
			.replace(/`(.+?)`/g, '$1')
			.trim();
	}

	// Get icon emoji/symbol based on icon type
	function getIconSymbol(icon) {
		const iconMap = {
			'newspaper': 'ðŸ“°',
			'propose': 'ðŸ“œ',
			'cosign': 'âœï¸',
			'meet': 'ðŸ‘¤',
			'blog': 'ðŸ“¡',
			'transpal': 'ðŸŽ™ï¸'
		};
		return iconMap[icon] || 'âœ¨';
	}

	// Fetch index cards data from worker API
	async function loadHomeFeeds() {
		const container = document.getElementById('homefeeds-container');
		if (!container) return;

		const currentLang = container.dataset.lang || 'zh-TW';

		try {
			const response = await fetch(`/api/index-cards?lang=${currentLang}`);
			if (!response.ok) {
				throw new Error(`HTTP ${response.status}: ${response.statusText}`);
			}

			const data = await response.json();

			// Map data to sections
			const sections = sectionsConfig.map(config => {
				let cards = [];
				if (config.key === 'news') {
					cards = data.newsCards || [];
				} else if (config.key === 'legislator') {
					cards = (data.legislatorCards || []).slice().reverse();
				} else if (config.key === 'blog') {
					cards = (data.blogCards || []).reverse();
				} else if (config.key === 'transpal') {
					cards = data.transpalCards || [];
				}
				return { ...config, cards };
			});

			// Render sections
			container.innerHTML = sections.map((sec, sIndex) => {
				const cardsHtml = (sec.cards || []).slice(0, sec.max).map((c, index) => {
					const delayMs = sIndex * 150 + index * 120;
					const transformStyle = sec.type === 'display'
						? calcDisplayTransform(index)
						: calcAlbumTransform(index);
					const styleStr = `--delay:${delayMs}ms; ${transformStyle}`;
					const iconSymbol = getIconSymbol(c.icon);

					return `
						<div
							class="border-muted-foreground/10 absolute top-1/2 left-1/2 w-[min(26rem,65vw)] -translate-x-1/2 -translate-y-1/2 transform-gpu rounded-xl border px-6 py-4 backdrop-blur-sm select-none data-[type=album]:bg-linear-to-b data-[type=display]:bg-linear-to-br from-muted/50 to-muted/25"
							style="${styleStr}"
							data-type="${sec.type}"
						>
							<div class="home-card-appear">
								<div class="${c.description ? 'flex flex-col h-28 justify-between' : 'flex flex-col h-18 justify-center gap-3'}">
									<div class="flex items-center gap-2">
										<span class="relative inline-flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-gray-50/50 text-gray-500 drop-shadow-md dark:bg-white/5 dark:text-white/80 text-base">
											${iconSymbol}
										</span>
										<p class="line-clamp-2 text-sm font-medium dark:text-white/80">${c.title || ''}</p>
									</div>
									${c.description ? `<p class="line-clamp-2 text-sm dark:text-white/50">${removeMarkdown(c.description)}</p>` : ''}
									<p class="text-muted-foreground text-xs">${c.date || ''}</p>
								</div>
							</div>
						</div>
					`;
				}).join('');

				const arrowIcon = sec.href && sec.href.startsWith('http')
					? '<svg class="lucide-arrow-up-right h-6 w-6 transition-transform group-hover:translate-x-0.5 group-hover:-translate-y-0.5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7h10v10"/><path d="M7 17 17 7"/></svg>'
					: '<svg class="lucide-arrow-right h-6 w-6 transition-transform group-hover:translate-x-0.5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>';

				return `
					<a
						class="section-card group bg-muted/50 hover:bg-muted relative flex shrink-0 flex-col overflow-hidden rounded-lg transition-colors max-lg:w-[50vw] max-md:w-[70vw]"
						href="${sec.href}"
					>
						<div class="p-4 md:p-6">
							<div class="relative flex h-60 flex-col data-[type=display]:max-md:scale-75" data-type="${sec.type}">
								${cardsHtml}
							</div>
						</div>
						<div class="text-foreground relative z-10 flex w-full items-center justify-between gap-2 bg-black/5 p-4 py-3 backdrop-blur-sm md:p-6 md:py-4 dark:bg-white/5">
							<header>
								<h2 class="line-clamp-1 font-semibold md:text-xl">${sec.title}</h2>
								<p class="text-muted-foreground line-clamp-1 text-sm opacity-75 md:text-base">${sec.subtitle}</p>
							</header>
							${arrowIcon}
						</div>
					</a>
				`;
			}).join('');

		} catch (error) {
			console.error('Failed to load home feeds:', error);
			// Show error state - keep skeleton cards visible
			// Could enhance this with a retry button or error message
		}
	}

	// Load data when DOM is ready
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', loadHomeFeeds);
	} else {
		loadHomeFeeds();
	}
</script>
