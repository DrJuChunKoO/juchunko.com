---
import { useTranslations } from "src/i18n/utils";
import AlbumCards from "./ui/album-cards.tsx";
import { ArrowUpRight } from "lucide-react";
import { timeAgo } from "../lib/utils";
type SupportedLang = "en" | "zh-TW";

interface BlogPost {
	id: string;
	title: string;
	description?: string;
	link: string;
	pubDate: string;
	category?: string;
	author?: string;
}

type BlogRssProps = {
	lang?: SupportedLang;
	limit?: number;
};

const { lang = "zh-TW", limit = 3 } = Astro.props as BlogRssProps;
const t = useTranslations(lang);

const RSS_URL = "https://blog.juchunko.com/rss.xml";

const dateFormatter = new Intl.DateTimeFormat(lang === "en" ? "en-US" : "zh-TW", {
	year: "numeric",
	month: lang === "en" ? "short" : "2-digit",
	day: "2-digit",
});

function decodeHtmlEntities(text: string): string {
	if (!text) return text;
	const namedEntities: Record<string, string> = {
		"&apos;": "'",
		"&quot;": '"',
		"&amp;": "&",
		"&lt;": "<",
		"&gt;": ">",
		"&nbsp;": "\u00a0",
		"&hellip;": "…",
		"&mdash;": "—",
	};

	return text.replace(/<!\[CDATA\[(.*?)\]\]>|&(?:#\d+|#x[0-9a-fA-F]+|[a-zA-Z]+);/gs, (m, c) => {
		if (c !== undefined) return c;
		return namedEntities[m] ?? m;
	});
}

async function fetchRSS(): Promise<BlogPost[]> {
	try {
		const response = await fetch(RSS_URL, {
			method: "GET",
			headers: { accept: "application/xml" },
			cache: "no-store",
		});

		if (!response.ok) throw new Error(`Failed to fetch RSS: ${response.status} ${response.statusText}`);
		const xml = await response.text();

		const items: BlogPost[] = [];
		const itemRegex = /<item>(.*?)<\/item>/gs;
		const titleRegex = /<title>([\s\S]*?)<\/title>/i;
		const linkRegex = /<link>([\s\S]*?)<\/link>/i;
		const descriptionRegex = /<description>([\s\S]*?)<\/description>/i;
		const pubDateRegex = /<pubDate>([\s\S]*?)<\/pubDate>/i;
		const categoryRegex = /<category>([\s\S]*?)<\/category>/i;
		const authorRegex = /<author>([\s\S]*?)<\/author>/i;
		const guidRegex = /<guid[^>]*>([\s\S]*?)<\/guid>/i;

		let m;
		while ((m = itemRegex.exec(xml)) !== null) {
			const itemXml = m[1];
			const titleMatch = titleRegex.exec(itemXml);
			const linkMatch = linkRegex.exec(itemXml);
			const descMatch = descriptionRegex.exec(itemXml);
			const pubMatch = pubDateRegex.exec(itemXml);
			const catMatch = categoryRegex.exec(itemXml);
			const authorMatch = authorRegex.exec(itemXml);
			const guidMatch = guidRegex.exec(itemXml);

			if (!titleMatch || !linkMatch) continue;

			const link = linkMatch[1].trim();
			const isEnglishPost = link.includes("/en/");
			const isChinesePost = link.includes("/zh/") || (!link.includes("/en/") && !link.includes("/zh/"));
			const shouldInclude = (lang === "en" && isEnglishPost) || (lang === "zh-TW" && isChinesePost);
			if (!shouldInclude) continue;

			const title = decodeHtmlEntities(titleMatch[1].replace(/<!\[CDATA\[(.*?)\]\]>/gs, "$1")).trim();
			const description = descMatch ? decodeHtmlEntities(descMatch[1].replace(/<!\[CDATA\[(.*?)\]\]>/gs, "$1")).trim() : "";
			const id = guidMatch ? guidMatch[1].trim() : link;
			const pubDate = pubMatch ? pubMatch[1].trim() : "";
			const category = catMatch ? decodeHtmlEntities(catMatch[1].trim()) : undefined;
			const author = authorMatch ? decodeHtmlEntities(authorMatch[1].trim()) : undefined;

			items.push({ id, title, description, link, pubDate, category, author });
		}

		return items;
	} catch (err) {
		console.error(err);
		return [];
	}
}

let posts: BlogPost[] = [];
let fetchError = false;

try {
	const allPosts = await fetchRSS();
	posts = allPosts.slice(0, limit);
} catch (e) {
	console.error("Failed to fetch blog RSS:", e);
	fetchError = true;
}

const cardItems = posts.map((post) => {
	return {
		title: post.title,
		description: post.description,
		date: post.pubDate ? timeAgo(post.pubDate, lang) : "",
		href: post.link ? post.link : `/`,
		icon: "blog",
	};
});
---

<a
	class="group relative block overflow-hidden rounded-lg bg-gray-50 transition-colors hover:bg-gray-100 dark:bg-white/5 dark:hover:bg-white/10"
	href="https://blog.juchunko.com/"
	target="_blank"
	rel="noopener noreferrer"
>
	<AlbumCards client:only="react" cards={cardItems} />
	<div class="flex w-full items-center justify-between gap-2 bg-[#F2F3F5] p-4 py-3 md:p-6 md:py-4 dark:bg-[#252424]">
		<header>
			<h2 class="font-semibold text-slate-900 md:text-xl dark:text-white">{t("home.blogRss.title")}</h2>
			<p class="text-xs text-slate-600 md:text-sm dark:text-white/50">{t("home.blogRss.subtitle")}</p>
		</header>
		<ArrowUpRight className="size-5 text-gray-600 dark:text-white/80" />
	</div>
</a>
