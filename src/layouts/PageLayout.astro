---
import Layout from "./Layout.astro";
import Nav from "../components/Nav.astro";
import Footer from "@/components/Footer.astro";
import BaseHead from "@/components/BaseHead.astro";
import { getLangFromUrl, useTranslations } from "../i18n/utils";
import type { CollectionEntry } from "astro:content";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

export interface Props {
	post?: CollectionEntry<"fragment" | "manual" | "act">;
	title?: string;
	description?: string;
	image?: string;
}

const { post, title, description, image } = Astro.props;
const pageTitle = title || post?.data.title || t("site.title");
const pageDescription = description || post?.data.description || t("home.description");
const pageImage = image || post?.data.image || "/favicon.png";
---

<Layout>
	<BaseHead title={pageTitle} description={pageDescription} image={pageImage} url={Astro.url.href} slot="head" />

	<div class="relative flex min-h-[100svh] w-[100vw] flex-col">
		<div
			class="pointer-events-none absolute inset-0 -z-10 hidden h-[100svh] w-full bg-gradient-to-b from-gray-50 via-transparent md:block dark:from-white/10"
		>
		</div>
		<Nav />
		<div
			class="relative mx-auto w-full max-w-[90rem] flex-1 rounded-t-2xl bg-white py-10 pr-[max(env(safe-area-inset-right),2rem)] pl-[max(env(safe-area-inset-left),2rem)] md:max-w-[90vw] md:py-16 dark:bg-white/5"
		>
			<div
				class="pointer-events-none absolute top-0 left-0 hidden h-[90svh] w-full rounded-t-2xl border border-gray-100 md:block md:shadow-xl dark:border-white/5"
				style={{
					mask: `linear-gradient(to bottom, #000 0%, rgba(0,0,0,0) 50%)`,
				}}
			>
			</div>
			<slot />
		</div>
		<Footer />
	</div>
</Layout>

<script is:inline>
	// 將邏輯抽成函式，方便在載入與滾動時重用
	function applyScrollClasses() {
		const scrollTop = window.scrollY;
		const windowHeight = window.innerHeight;

		if (scrollTop > 0) {
			document.body.classList.add("scrolled");
		} else {
			document.body.classList.remove("scrolled");
		}

		if (scrollTop >= windowHeight / 2) {
			document.body.classList.add("scrolled-full");
		} else {
			document.body.classList.remove("scrolled-full");
		}
	}

	// 在 DOM 內容就緒時立即執行一次，避免首次渲染樣式錯誤
	function initScrollClassHandling() {
		applyScrollClasses();
		window.addEventListener("scroll", applyScrollClasses, { passive: true });
	}

	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", initScrollClassHandling, { once: true });
	} else {
		// 若腳本被延後載入或在 bfcache 恢復的情境下，立即執行一次
		initScrollClassHandling();
	}

	// 處理瀏覽器前進/返回快取恢復（bfcache），確保樣式正確
	window.addEventListener("pageshow", (e) => {
		// 在 bfcache 恢復時 (persisted 為 true) 或一般顯示時都套用一次，確保狀態正確
		applyScrollClasses();
	});
</script>
