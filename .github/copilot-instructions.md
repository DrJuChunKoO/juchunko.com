# AI Coding Agent Instructions for `juchunko.com`

Concise, project-specific guidance for working productively in this Astro + React + Cloudflare Workers codebase. Focus on existing patterns—do not invent new abstractions unless clearly needed.

## Overview & Architecture

- Framework: Astro 5 with hybrid Astro `.astro` pages/layouts and React 19 islands (`@astrojs/react`). Tailwind CSS 4 via Vite plugin; icons via `unplugin-icons`.
- Content system: `src/content.config.ts` defines three MDX collections (`act`, `manual`, `fragment`) with identical schema (title/date/emoji/optional description/image). Localized content stored under `src/content/{collection}/{lang}/...`.
- Internationalization: Astro i18n configured in `astro.config.mjs` with locales `zh-TW` (default) and `en`. URL structure always prefixed with locale (`/zh-TW/...` or `/en/...`). Utility functions in `src/i18n/utils.ts`; translation keys in `src/i18n/ui.ts`.
- Pages: Dynamic language scoped routes in `src/pages/[lang]/**`. The home page (`src/pages/[lang]/index.astro`) loads collections filtered by `post.id.startsWith(lang + '/')`.
- Layout & Styling: Global layout `src/layouts/Layout.astro` plus `PageLayout.astro` (not shown here). Global styles in `src/styles/global.css`. Use Tailwind utility classes; merge class names with `cn()` helper in `src/lib/utils.ts`.
- Interactive features: React components providing UI islands (e.g. `Agent.tsx`, `AIAssistantWindow.tsx`, `LanguageSelector.tsx`). Motion animations via `motion/react` (Framer Motion v12). Keep DOM order for accessibility; use `AnimatePresence` + `Variants` for enter/exit symmetry.
- AI Chat API: Cloudflare Worker in `src/worker/index.ts` exposes `POST /api/chat`. Streams responses using `@ai-sdk/openai` + `ai` package tools. System prompt localized & page-aware. Frontend integrates through `useChat` with `DefaultChatTransport` (`AIAssistantWindow.tsx`).
- Deployment: Built site assets served by Cloudflare Workers (see `wrangler.jsonc` `assets.directory: ./dist`). Worker entry: `main: ./src/worker/index.ts`.

## Key Conventions

- Content lookup: Pages derive language from URL via `getLangFromUrl(Astro.url)`; do not rely on browser locale.
- Filtering collections: Filter by `post.id.startsWith(lang + '/')` after `getCollection("act")` etc. Maintain descending date sort using `b.data.date.valueOf()`.
- Translation access: Obtain closure `t = useTranslations(lang)` then call `t("home.title")`. Fallback to default language is built-in; don't reimplement.
- Time formatting: Use `timeAgo(dateString, lang)` from `src/lib/utils.ts` for relative timestamps; do not duplicate logic.
- React island positioning: Windows (`AIAssistantWindow`, `VoiceReaderWindow`, `PhoneCallInterface`) anchored with `motion.div` and a `useMotionValue` for `bottom` distance reacting to footer visibility.
- Animation: Respect `useReducedMotion()` for accessibility; variants generated by functions to avoid SSR/hydration issues.
- Language switching (client): `LanguageSelector.tsx` rewrites the leading locale segment and reloads. Preserve rest of path, only replace initial `/(en|zh-TW)`.
- System prompt additions: If adjusting tools/prompts, keep core constraints (concise answers, language match, page guarding against hallucination).

## Working with the AI Chat

- API contract: Request body `{ messages: ModelMessage[], filename: string }`; server derives system prompt & streams SSE. Frontend sends `{ text: string }` per message via `sendMessage`.
- Tool: `viewPage` fetches raw MDX from GitHub `main` branch. Route parsing: `/{lang}/{contentType}/{slug}` -> `src/content/{contentType}/{lang}/{slug}.mdx`.
- When modifying Worker, ensure CORS headers remain and `Content-Type: text/event-stream` for streaming.

## Adding Content

1. Create MDX in `src/content/<collection>/<lang>/<slug>.mdx`.
2. Ensure frontmatter matches schema: `title`, `date`, optional `emoji`, `description`, `image`.
3. No additional registration needed—`getCollection()` auto-picks it.
4. For cross-language parity, mirror slug names across `en` and `zh-TW` where applicable.

## Adding Translations

- Add new keys consistently to both locales in `src/i18n/ui.ts`. If a key is missing in a locale, fallback returns default language value—verify UI expectations.

## Typical Commands

```sh
pnpm install        # install deps
pnpm dev            # start Astro dev server (default port 4321)
pnpm build          # output to dist/ for worker assets
pnpm preview        # local preview of production build
```

## Extension / Refactor Guidelines

- Prefer extending existing patterns (e.g., replicate collection schema if adding new content type) rather than inventing new global state.
- Keep Node APIs / OpenAI calls confined to the Worker; do not call external LLM APIs directly from React islands.
- Maintain locale prefix in any new routes; update `getStaticPaths()` for language-specific pages.
- For new streaming tools, follow the structure of existing `tool({ description, inputSchema, execute })` usage.

## Pitfalls & Edge Cases

- Missing or malformed route for `viewPage` tool returns an error string—handle gracefully client-side if consumed.
- `useReducedMotion()` may return `null` during hydration—cast to boolean as in `Agent.tsx`.
- Ensure `date` in frontmatter parses correctly (`z.coerce.date()`); invalid date strings will throw at build time.
- Avoid direct mutation of `messages` from `useChat`; use provided `sendMessage`.

## Safe Changes Examples

- Adding a new translation key: edit both locale objects in `ui.ts` and use via `t("new.key")`.
- Adding a new AI quick prompt: extend `quickPrompts` array in `AIAssistantWindow.tsx`; ensure uniqueness to avoid filter suppression.
- Adding new content: create MDX file; verify with `pnpm build`—no code change required.

## Do Not

- Remove locale prefixing or fallback logic.
- Introduce blocking synchronous operations inside Worker streaming loop.
- Hardcode asset paths without using existing directory conventions.

Feedback welcome—request clarifications if any section seems incomplete or if new patterns emerge.
